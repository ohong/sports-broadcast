#!/usr/bin/env python3
"""
Toolhouse Agent Client

A Python script that takes a string input, sends it to a Toolhouse agent,
and returns the agent's response as a string.

Requirements:
- requests library (pip install requests)
- Toolhouse API key and Agent ID

Usage:
    python toolhouse_agent_client.py
    or
    from toolhouse_agent_client import ToolhouseClient
    client = ToolhouseClient(api_key="your_key", agent_id="your_agent_id")
    response = client.send_message("Hello, agent!")
"""

import requests
import json
import os
from typing import Optional, Dict, Any


class ToolhouseClient:
    """Client for interacting with Toolhouse agents."""
    
    def __init__(self, api_key: Optional[str] = None, agent_id: Optional[str] = None):
        """
        Initialize the Toolhouse client.
        
        Args:
            api_key: Toolhouse API key. If None, will try to get from environment variable TOOLHOUSE_API_KEY
            agent_id: Toolhouse Agent ID. If None, will try to get from environment variable TOOLHOUSE_AGENT_ID
        """
        # Default credentials (can be overridden by parameters or environment variables)
        default_api_key = "th-BUODo3IXaJev9o9IkoTKzKYem19_S85MsDPk9-pS1Kw"
        default_agent_id = "6fdb94c6-fd28-4b98-9b7b-616d411ac8c5"
        
        self.api_key = api_key or os.getenv('TOOLHOUSE_API_KEY') or default_api_key
        self.agent_id = agent_id or os.getenv('TOOLHOUSE_AGENT_ID') or default_agent_id
        
        # Note: Default credentials are now provided, so these checks are mainly for validation
        if not self.api_key:
            raise ValueError("Toolhouse API key is required.")
        
        if not self.agent_id:
            raise ValueError("Toolhouse Agent ID is required.")
        
        self.base_url = f"https://agents.toolhouse.ai/{self.agent_id}"
        self.headers = {
            'Authorization': f'Bearer {self.api_key}',
            'Content-Type': 'application/json'
        }
    
    def send_message(self, message: str) -> str:
        """
        Send a message to the Toolhouse agent and return the response.
        
        Args:
            message: The input string to send to the agent
            
        Returns:
            The agent's response as a string
            
        Raises:
            Exception: If the request fails or returns an error
        """
        payload = {
            'message': message
        }
        
        try:
            response = requests.post(
                self.base_url,
                headers=self.headers,
                json=payload,
                timeout=30  # 30 second timeout
            )
            
            if response.status_code == 200:
                # Check if response is empty
                if not response.text.strip():
                    return "Empty response received from agent"
                
                # Try to parse as JSON
                try:
                    response_data = response.json()
                    # Extract the actual response content
                    # The structure may vary depending on Toolhouse's response format
                    if isinstance(response_data, dict):
                        # Try common response field names
                        for field in ['response', 'message', 'content', 'output', 'text', 'data']:
                            if field in response_data:
                                return str(response_data[field])
                        # If no common field found, return the whole response as string
                        return str(response_data)
                    else:
                        return str(response_data)
                except json.JSONDecodeError:
                    # If it's not JSON, return the raw text
                    return response.text
            else:
                raise Exception(f'HTTP Error {response.status_code}: {response.text}')
                
        except requests.exceptions.RequestException as e:
            raise Exception(f'Request failed: {str(e)}')
        except Exception as e:
            raise Exception(f'Unexpected error: {str(e)}')


def main():
    """Main function for command-line usage."""
    print("Toolhouse Agent Client")
    print("=" * 50)
    
    try:
        # Initialize client (will use environment variables if available)
        client = ToolhouseClient()
        
        # Get input from user
        user_input = input("Enter your message for the Toolhouse agent: ")
        
        if not user_input.strip():
            print("Error: Empty input provided.")
            return
        
        print(f"\nSending message: '{user_input}'")
        print("Waiting for agent response...")
        
        # Send message and get response
        response = client.send_message(user_input)
        
        print(f"\nAgent Response:")
        print("-" * 30)
        print(response)
        
    except ValueError as e:
        print(f"Configuration Error: {e}")
        print("\nNote: Default credentials are provided in the script.")
        print("You can also set environment variables to override them:")
        print("  TOOLHOUSE_API_KEY=your_api_key")
        print("  TOOLHOUSE_AGENT_ID=your_agent_id")
        
    except Exception as e:
        print(f"Error: {e}")


if __name__ == '__main__':
    main()
